import{a as D,b,c as N,d as j,e as A,f as B,g as L,h as G,i as U,j as f,k as q}from"./chunk-OGTIXNAF.js";import{b as E,c as T,f as z}from"./chunk-PCKYNI25.js";import{$a as O,Ab as F,Bb as k,Ca as d,Ha as S,La as p,O as C,S as M,Sa as c,Ta as r,Ua as s,Va as y,Za as u,_a as g,ab as a,bb as h,cb as x,eb as P,fb as I,sa as i,yb as R,zb as w}from"./chunk-5YBEVAAG.js";import"./chunk-LJ5XHLMQ.js";import{h as m}from"./chunk-FK42CRUA.js";var v=class n{constructor(t){this.supabaseService=t}channels=new Map;fetchMessages(t){return m(this,null,function*(){let e=new Date(Date.now()-864e5).toISOString(),{data:o,error:l}=yield this.supabaseService.client.from("messages").select("*").eq("room_id",t).gt("created_at",e).order("created_at",{ascending:!0});return{data:o,error:l}})}sendMessage(t,e,o){return m(this,null,function*(){let{data:l,error:_}=yield this.supabaseService.client.from("messages").insert([{room_id:t,content:e,user_id:o}]).select().single();return{data:l,error:_}})}listenToRoom(t,e){this.channels.has(t)&&this.channels.get(t)?.unsubscribe();let o=this.supabaseService.client.channel(`room-${t}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`room_id=eq.${t}`},l=>{e(l.new)}).subscribe();return this.channels.set(t,o),o}unsubscribeFromRoom(t){let e=this.channels.get(t);e&&(e.unsubscribe(),this.channels.delete(t))}unsubscribeFromAllRooms(){this.channels.forEach(t=>{t.unsubscribe()}),this.channels.clear()}static \u0275fac=function(e){return new(e||n)(M(f))};static \u0275prov=C({token:n,factory:n.\u0275fac,providedIn:"root"})};function K(n,t){if(n&1&&(r(0,"div",13),a(1),s()),n&2){let e=g();i(),x(" ",e.errorMessage," ")}}function Q(n,t){n&1&&(r(0,"div",14),a(1," Loading messages... "),s())}function W(n,t){n&1&&(r(0,"div",18)(1,"p"),a(2,"No messages yet. Be the first to send a message!"),s()())}function X(n,t){if(n&1&&(r(0,"span",25),a(1),s()),n&2){let e=g().$implicit;i(),x("User: ",e.user_id.substring(0,8),"...")}}function Y(n,t){if(n&1&&(r(0,"div",19)(1,"div",20)(2,"div",21),a(3),s(),r(4,"div",22)(5,"span",23),a(6),P(7,"date"),s(),p(8,X,2,1,"span",24),s()()()),n&2){let e=t.$implicit;i(3),h(e.content),i(3),h(I(7,3,e.created_at,"short")),i(2),c("ngIf",e.user_id)}}function Z(n,t){if(n&1&&(r(0,"div",15),p(1,W,3,0,"div",16)(2,Y,9,6,"div",17),s()),n&2){let e=g();i(),c("ngIf",e.messages.length===0),i(),c("ngForOf",e.messages)}}function ee(n,t){n&1&&(r(0,"span"),a(1,"Message is required"),s())}function te(n,t){if(n&1&&(r(0,"div",13),p(1,ee,2,0,"span",26),s()),n&2){let e=g();i(),c("ngIf",e.content==null||e.content.errors==null?null:e.content.errors.required)}}var $=class n{constructor(t,e,o,l,_,ne){this.route=t;this.router=e;this.fb=o;this.authService=l;this.chatService=_;this.supabaseService=ne;this.messageForm=this.fb.group({content:["",[b.required,b.minLength(1)]]})}roomId=null;room=null;messages=[];messageForm;currentUser=null;isLoading=!1;errorMessage="";ngOnInit(){return m(this,null,function*(){if(this.roomId=this.route.snapshot.paramMap.get("id"),!this.roomId){this.router.navigate(["/home"]);return}if(this.currentUser=yield this.authService.getSession(),!this.currentUser?.user){this.router.navigate(["/login"]);return}yield this.loadRoomDetails(),yield this.loadMessages(),this.subscribeToMessages()})}ngOnDestroy(){this.roomId&&this.chatService.unsubscribeFromRoom(this.roomId)}loadRoomDetails(){return m(this,null,function*(){if(!this.roomId)return;let{data:t,error:e}=yield this.supabaseService.getRoomById(this.roomId);e?(console.error("Error loading room:",e),this.errorMessage="Room not found"):this.room=t})}loadMessages(){return m(this,null,function*(){if(!this.roomId)return;this.isLoading=!0;let{data:t,error:e}=yield this.chatService.fetchMessages(this.roomId);e?(console.error("Error loading messages:",e),this.errorMessage="Failed to load messages"):this.messages=t||[],this.isLoading=!1})}subscribeToMessages(){this.roomId&&this.chatService.listenToRoom(this.roomId,t=>{this.messages.push(t)})}sendMessage(){return m(this,null,function*(){if(this.messageForm.valid&&this.roomId&&this.currentUser?.user){let{content:t}=this.messageForm.value,{error:e}=yield this.chatService.sendMessage(this.roomId,t,this.currentUser.user.id);e?(console.error("Error sending message:",e),this.errorMessage="Failed to send message"):(this.messageForm.reset(),this.errorMessage="")}})}goBack(){this.router.navigate(["/home"])}signOut(){return m(this,null,function*(){yield this.authService.signOut()})}get content(){return this.messageForm.get("content")}static \u0275fac=function(e){return new(e||n)(d(E),d(T),d(G),d(q),d(v),d(f))};static \u0275cmp=S({type:n,selectors:[["app-chat-room"]],decls:19,vars:9,consts:[[1,"chat-room-container"],[1,"chat-room-header"],[1,"back-button",3,"click"],[1,"sign-out-button",3,"click"],[1,"chat-room-content"],["class","error-message",4,"ngIf"],["class","loading-message",4,"ngIf"],["class","messages-container",4,"ngIf"],[1,"message-input-container"],[1,"message-form",3,"ngSubmit","formGroup"],[1,"input-group"],["type","text","formControlName","content","placeholder","Type your message...",1,"message-input"],["type","submit",1,"send-button",3,"disabled"],[1,"error-message"],[1,"loading-message"],[1,"messages-container"],["class","no-messages",4,"ngIf"],["class","message-item",4,"ngFor","ngForOf"],[1,"no-messages"],[1,"message-item"],[1,"message-content"],[1,"message-text"],[1,"message-meta"],[1,"message-time"],["class","message-user",4,"ngIf"],[1,"message-user"],[4,"ngIf"]],template:function(e,o){e&1&&(r(0,"div",0)(1,"div",1)(2,"button",2),u("click",function(){return o.goBack()}),a(3,"\u2190 Back to Home"),s(),r(4,"h1"),a(5),s(),r(6,"button",3),u("click",function(){return o.signOut()}),a(7,"Sign Out"),s()(),r(8,"div",4),p(9,K,2,1,"div",5)(10,Q,2,0,"div",6)(11,Z,3,2,"div",7),r(12,"div",8)(13,"form",9),u("ngSubmit",function(){return o.sendMessage()}),r(14,"div",10),y(15,"input",11),r(16,"button",12),a(17," Send "),s()(),p(18,te,2,1,"div",5),s()()()()),e&2&&(i(5),h((o.room==null?null:o.room.name)||"Loading..."),i(4),c("ngIf",o.errorMessage),i(),c("ngIf",o.isLoading),i(),c("ngIf",!o.isLoading),i(2),c("formGroup",o.messageForm),i(2),O("error",(o.content==null?null:o.content.invalid)&&(o.content==null?null:o.content.touched)),i(),c("disabled",o.messageForm.invalid),i(2),c("ngIf",(o.content==null?null:o.content.invalid)&&(o.content==null?null:o.content.touched)))},dependencies:[k,R,w,z,U,A,D,N,j,B,L,F],styles:[".chat-room-container[_ngcontent-%COMP%]{min-height:100vh;background-color:var(--bg-color);color:var(--text-color);display:flex;flex-direction:column}.chat-room-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:1px solid var(--border-color);background-color:var(--bg-color);position:sticky;top:0;z-index:10}.chat-room-header[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{font-size:24px;font-weight:600;margin:0;flex:1;text-align:center;color:var(--text-color)}.back-button[_ngcontent-%COMP%]{background-color:transparent;color:var(--text-color);border:1px solid var(--border-color);padding:12px 24px;border-radius:4px;font-size:14px;font-weight:700;cursor:pointer;transition:all .2s ease}.back-button[_ngcontent-%COMP%]:hover{background-color:var(--border-color)}.sign-out-button[_ngcontent-%COMP%]{background-color:var(--primary-accent);color:var(--bg-color);border:none;padding:12px 24px;border-radius:4px;font-size:14px;font-weight:700;cursor:pointer;transition:all .2s ease}.sign-out-button[_ngcontent-%COMP%]:hover{opacity:.9}.chat-room-content[_ngcontent-%COMP%]{flex:1;display:flex;flex-direction:column;max-width:800px;margin:0 auto;width:100%;padding:0 20px}.error-message[_ngcontent-%COMP%]{background-color:#dc26261a;border:1px solid #dc2626;color:#dc2626;padding:12px;border-radius:4px;margin:20px 0;font-size:14px}.loading-message[_ngcontent-%COMP%]{text-align:center;padding:40px 20px;color:var(--text-color);opacity:.7;font-size:16px}.messages-container[_ngcontent-%COMP%]{flex:1;overflow-y:auto;padding:20px 0;display:flex;flex-direction:column;gap:16px}.no-messages[_ngcontent-%COMP%]{text-align:center;padding:40px 20px}.no-messages[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:var(--text-color);opacity:.7;font-size:16px;margin:0}.message-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:flex-start}.message-content[_ngcontent-%COMP%]{background-color:transparent;border:1px solid var(--border-color);border-radius:8px;padding:12px 16px;max-width:70%;position:relative}.message-text[_ngcontent-%COMP%]{font-size:16px;line-height:1.4;margin-bottom:8px;color:var(--text-color);word-wrap:break-word}.message-meta[_ngcontent-%COMP%]{display:flex;gap:12px;font-size:12px;color:var(--text-color);opacity:.6}.message-time[_ngcontent-%COMP%]{font-weight:500}.message-user[_ngcontent-%COMP%]{font-weight:400}.message-input-container[_ngcontent-%COMP%]{background-color:var(--bg-color);border-top:1px solid var(--border-color);padding:20px;position:sticky;bottom:0}.message-form[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:8px}.input-group[_ngcontent-%COMP%]{display:flex;gap:12px;align-items:flex-end}.message-input[_ngcontent-%COMP%]{flex:1;background-color:transparent;border:1px solid var(--border-color);color:var(--text-color);padding:12px;border-radius:4px;font-size:16px;transition:border-color .2s ease;resize:none}.message-input[_ngcontent-%COMP%]:focus{outline:none;border-color:var(--primary-accent)}.message-input.error[_ngcontent-%COMP%]{border-color:#dc2626}.message-input[_ngcontent-%COMP%]::placeholder{color:var(--text-color);opacity:.5}.send-button[_ngcontent-%COMP%]{background-color:var(--primary-accent);color:var(--bg-color);border:none;padding:12px 24px;border-radius:4px;font-size:16px;font-weight:700;cursor:pointer;transition:all .2s ease;white-space:nowrap}.send-button[_ngcontent-%COMP%]:hover:not(:disabled){opacity:.9}.send-button[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}@media (max-width: 768px){.chat-room-header[_ngcontent-%COMP%]{padding:16px}.chat-room-header[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{font-size:20px}.back-button[_ngcontent-%COMP%], .sign-out-button[_ngcontent-%COMP%]{padding:10px 16px;font-size:12px}.chat-room-content[_ngcontent-%COMP%]{padding:0 16px}.message-content[_ngcontent-%COMP%]{max-width:85%}.message-input-container[_ngcontent-%COMP%]{padding:16px}.input-group[_ngcontent-%COMP%]{gap:8px}.send-button[_ngcontent-%COMP%]{padding:12px 20px;font-size:14px}}"]})};export{$ as ChatRoomComponent};
