<div class="chat-room-container">
  <!-- Header -->
  <div class="chat-header">
    <div class="header-left">
      <button 
        (click)="goBack()" 
        class="back-button"
        appSoundClick
        soundType="button">
        <span class="back-icon">‚Üê</span>
        <span class="back-text">Quay l·∫°i</span>
      </button>
    </div>
    <div class="header-center">
      <div class="room-logo-container">
        <div class="room-logo-icon">
          <svg class="room-logo-svg" viewBox="0 0 32 32" width="24" height="24">
            <defs>
              <linearGradient id="roomLogoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#8b5cf6;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#a78bfa;stop-opacity:1" />
              </linearGradient>
            </defs>
            <g fill="none" stroke="url(#roomLogoGrad)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M8 10c-1 0-2 1-2 2v8c0 1 1 2 2 2h1"/>
              <path d="M9 12h14c1 0 2 1 2 2v4c0 1-1 2-2 2h-8l-3 3v-3H9c-1 0-2-1-2-2v-4c0-1 1-2 2-2z"/>
              <path d="M23 10c1 0 2 1 2 2v8c0 1-1 2-2 2h-1"/>
            </g>
            <circle cx="14" cy="16" r="1" fill="url(#roomLogoGrad)"/>
            <circle cx="18" cy="16" r="1" fill="url(#roomLogoGrad)"/>
          </svg>
        </div>
        <h1 class="room-title">{{ room?.name || 'ƒêang t·∫£i...' }}</h1>
      </div>
      <div class="room-status">
        <div class="cleanup-notice">
          <span class="cleanup-icon">üïõ</span>
          <span class="cleanup-text">T·ª± ƒë·ªông x√≥a l√∫c 00:00</span>
        </div>
        
        <!-- Encryption Status -->
        <div class="encryption-status" *ngIf="encryptionService.isEncryptionAvailable()">
          <span class="encryption-icon">üîê</span>
          <span class="encryption-text">End-to-End Encrypted</span>
        </div>
      </div>
    </div>
          <div class="header-right">
            <label class="modern-toggle-switch" [title]="!roomVisibilityToggle ? 'ƒêang ·∫©n' : 'ƒêang c√¥ng khai'">
              <input 
                type="checkbox" 
                [checked]="!roomVisibilityToggle"
                (change)="toggleRoomVisibility()"
                aria-label="B·∫≠t/t·∫Øt hi·ªÉn th·ªã c√¥ng khai"
                appSoundClick
                soundType="toggle"
              />
              <span class="toggle-track">
                <span class="toggle-text">{{ !roomVisibilityToggle ? '·∫®N' : '' }}</span>
                <span class="toggle-thumb"></span>
              </span>
            </label>
           </div>
  </div>

  <!-- Countdown Timer -->
  <div class="countdown-section">
    <app-countdown-timer></app-countdown-timer>
  </div>

  <!-- Main Content -->
  <div class="chat-content">
    <!-- Password Modal -->
    <div *ngIf="showPasswordModal" class="password-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">
            <span class="modal-icon">üîí</span>
            Ph√≤ng ƒë∆∞·ª£c b·∫£o v·ªá
          </h2>
          <p class="modal-description">Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ v√†o ph√≤ng</p>
        </div>
        <div class="modal-body">
          <form [formGroup]="passwordForm" (ngSubmit)="verifyPassword()" class="password-form">
            <div class="form-group">
              <input
                type="password"
                formControlName="password"
                class="form-input"
                placeholder="Nh·∫≠p m·∫≠t kh·∫©u..."
                [class.error]="password?.invalid && password?.touched"
              />
              <div *ngIf="password?.invalid && password?.touched" class="error-message">
                <span *ngIf="password?.errors?.['required']">M·∫≠t kh·∫©u l√† b·∫Øt bu·ªôc</span>
              </div>
            </div>
            <button
              type="submit"
              class="btn-primary btn-lg w-full"
              [disabled]="passwordForm.invalid"
              appSoundClick
              soundType="button"
            >
              X√°c nh·∫≠n
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Room Settings Panel -->
    <div *ngIf="showRoomSettings" class="room-settings-panel">
      <div class="settings-content">
        <div class="settings-header">
          <h3 class="settings-title">C√†i ƒê·∫∑t Ph√≤ng</h3>
          <button (click)="toggleRoomSettings()" class="close-settings">
            <span class="close-icon">‚úï</span>
          </button>
        </div>
        
        <div class="settings-body">
          <div class="setting-item">
            <div class="setting-label">
              <span class="setting-icon">üåê</span>
              <span class="setting-text">Hi·ªÉn th·ªã c√¥ng khai</span>
            </div>
            <div class="setting-control">
              <label class="toggle-switch">
                <input 
                  type="checkbox" 
                  [checked]="roomVisibilityToggle"
                  (change)="toggleRoomVisibility()"
                />
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
          
          <div class="setting-description">
            <p *ngIf="roomVisibilityToggle" class="description-text">
              ‚úÖ Ph√≤ng n√†y s·∫Ω hi·ªÉn th·ªã trong danh s√°ch ph√≤ng c√¥ng khai
            </p>
            <p *ngIf="!roomVisibilityToggle" class="description-text">
              üîí Ph√≤ng n√†y s·∫Ω ·∫©n kh·ªèi danh s√°ch ph√≤ng c√¥ng khai
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Username Form -->
    <div *ngIf="!currentUsername && !isPasswordRequired" class="username-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">
            <span class="modal-icon">üëã</span>
            Ch√†o m·ª´ng b·∫°n!
          </h2>
          <p class="modal-description">Nh·∫≠p t√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu tr√≤ chuy·ªán</p>
        </div>
        <div class="modal-body">
          <form [formGroup]="usernameForm" (ngSubmit)="setUsername()" class="username-form">
            <div class="form-group">
              <input
                type="text"
                formControlName="username"
                class="form-input"
                placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..."
                [class.error]="username?.invalid && username?.touched"
                [value]="currentUsername || ''"
              />
              <div *ngIf="username?.invalid && username?.touched" class="error-message">
                <span *ngIf="username?.errors?.['required']">T√™n l√† b·∫Øt bu·ªôc</span>
              </div>
            </div>
            <button
              type="submit"
              class="btn-primary btn-lg w-full"
              [disabled]="usernameForm.invalid"
              appSoundClick
              soundType="success"
            >
              B·∫Øt ƒë·∫ßu chat
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Error Message -->
    <div *ngIf="errorMessage" class="error-banner">
      <span class="error-icon">‚ö†Ô∏è</span>
      {{ errorMessage }}
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-container">
      <div class="loading-spinner"></div>
      <p>ƒêang t·∫£i tin nh·∫Øn...</p>
    </div>

    <!-- Messages Container -->
    <div class="messages-container" *ngIf="!isLoading && currentUsername && !isPasswordRequired" #messagesContainer>
      <!-- Empty State -->
      <div *ngIf="messages.length === 0" class="empty-messages">
        <div class="empty-icon">üí¨</div>
        <h3>Ch∆∞a c√≥ tin nh·∫Øn n√†o</h3>
        <p>H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n g·ª≠i tin nh·∫Øn!</p>
      </div>

      <!-- Messages List -->
      <div class="messages-list" *ngIf="messages.length > 0">
        <div *ngFor="let message of messages; trackBy: trackByMessageId" 
             class="message-item" 
             [class.own-message]="isOwnMessage(message)"
             [class.other-message]="!isOwnMessage(message)"
             [style.--user-color]="getUserColor(message.user_id || '')"
             [style.--user-color-light]="getUserColorLight(message.user_id || '')"
             [style.--user-color-dark]="getUserColorDark(message.user_id || '')">
          <div class="message-content">
            <!-- Username for other messages -->
            <div *ngIf="!isOwnMessage(message)" class="message-username">
              {{ getMessageUsername(message) }}
            </div>
            <div class="message-text">{{ message.decryptedContent || message.content }}</div>
            <div class="message-meta">
              <span class="message-time">{{ message.created_at | date:'HH:mm' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Message Input -->
    <div class="message-input-container" *ngIf="currentUsername && !isPasswordRequired">
      <form [formGroup]="messageForm" (ngSubmit)="sendMessage()" class="message-form">
        <div class="input-group">
          <div class="input-wrapper">
            <input
              type="text"
              formControlName="content"
              class="message-input"
              placeholder="Nh·∫≠p tin nh·∫Øn..."
              [class.error]="content?.invalid && content?.touched"
            />
          </div>
          <button
            type="submit"
            class="send-button"
            [disabled]="messageForm.invalid || !canSendMessage()"
            [title]="!canSendMessage() ? 'Vui l√≤ng ƒë·ª£i ' + getRemainingCooldown() + ' gi√¢y' : 'G·ª≠i tin nh·∫Øn'"
            appSoundClick
            soundType="message"
          >
            <span class="send-icon" *ngIf="canSendMessage()">üì§</span>
            <span class="cooldown-text" *ngIf="!canSendMessage()">{{ getRemainingCooldown() }}</span>
          </button>
        </div>
        <div *ngIf="content?.invalid && content?.touched" class="error-message">
          <span *ngIf="content?.errors?.['required']">Tin nh·∫Øn l√† b·∫Øt bu·ªôc</span>
        </div>
      </form>
    </div>
  </div>

  <!-- Messages -->
  <div *ngIf="errorMessage" class="error-toast">
    <span class="error-icon">‚ö†Ô∏è</span>
    {{ errorMessage }}
  </div>

  <div *ngIf="successMessage" class="success-toast">
    <span class="success-icon">‚úÖ</span>
    {{ successMessage }}
  </div>

  <!-- Version Footer -->
  <div class="version-footer">
    <p class="version-text">Version 0.1</p>
  </div>
</div>
